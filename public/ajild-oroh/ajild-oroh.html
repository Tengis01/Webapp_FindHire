<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/public/ajild-oroh/ajild-oroh.css">
  <script type="module" src="/public/com/ch-header.js"></script>
  <script type="module" src="/public/com/ch-toast.js"></script>
  <title>Ажилд Орох</title>
</head>

<body>
  <ch-header></ch-header>
  <ch-toast></ch-toast>

  <form id="jobApplicationForm">
    <h1>Ажлын маягт</h1>
    <!-- e-Mongolia нэвтрэх хэсэг -->
    <div class="emongolia-section">
      <button type="button" class="emongolia-btn" onclick="loginWithEMongolia()">
        <span class="emongolia-icon">eM</span>
        e-Mongolia-аар автоматаар бөглөх
      </button>
    </div>
    <div class="first">
      <label for="last">Овог</label>
      <input type="text" id="last" name="last" placeholder="Өөрийн овог" required>
    </div>
    <div class="first">
      <label for="name">Нэр</label>
      <input type="text" id="name" name="name" placeholder="Өөрийн нэр" required>
    </div>
    <div>
      <label for="email">Email</label>
      <input type="email" placeholder="abc@example.com" required name="email" id="email">
    </div>
    <div>
      <label for="address">Хаяг</label>
      <input type="text" placeholder="Улаанбаатар" required name="address" id="address">
    </div>
    <div>
      <label for="password">Нууц үг</label>
      <input type="password" placeholder="Нууц үг" required name="password" id="password">
    </div>
    <div>
      <label for="posotion">Категори</label>
      <select name="category" id="category" required>
        <option value="">Сонгох</option>
        <option value="Дотор засал">Дотор засал</option>
        <option value="Тавилга угсралт">Тавилга угсралт</option>
        <option value="Цэвэрлэгээ">Цэвэрлэгээ</option>
        <option value="Нүүлгэлт">Нүүлгэлт</option>
        <option value="Сантехник">Сантехник</option>
        <option value="Гадна талбай">Гадна талбай</option>
        <option value="Цахилгаан">Цахилгаан</option>
      </select>
    </div>

    <div id="subcategory-container" style="display:none; margin-top:15px;">
      <label>Дэд категориуд</label>
      <div id="subcategory-options" style="display:flex; flex-direction:column; gap:8px; margin-top:5px;">
        <!-- Checkboxes will be injected here -->
      </div>
    </div>

    <div>
      <label for="experience">Ажлын туршлага:</label>
      <select id="experience" name="experience" required></select>
    </div>
    <div>
      <label for="dugaar">Холбогдох утасны дугаар</label>
      <input type="tel" name="dugaar" id="dugaar" placeholder="99003322" maxlength="8" pattern="[6-9][0-9]{7}" required>
    </div>
    <div>
      <fieldset class="radio-group" style="border:none; padding:0;">
        <legend style="margin-bottom:10px; font-weight:bold;">Ажиллах боломжтой өдрүүд</legend>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <label><input type="checkbox" name="availability" value="Даваа"> Даваа</label>
          <label><input type="checkbox" name="availability" value="Мягмар"> Мягмар</label>
          <label><input type="checkbox" name="availability" value="Лхагва"> Лхагва</label>
          <label><input type="checkbox" name="availability" value="Пүрэв"> Пүрэв</label>
          <label><input type="checkbox" name="availability" value="Баасан"> Баасан</label>
          <label><input type="checkbox" name="availability" value="Бямба"> Бямба</label>
          <label><input type="checkbox" name="availability" value="Ням"> Ням</label>
        </div>
      </fieldset>
    </div>
    <div class="second">
      <label for="message">Өөрийн тухай товч</label>
      <textarea name="message" id="message" placeholder="Өөрийн тухай товч"></textarea>
    </div>
    <div class="button">
      <button class="submit" type="submit">Илгээх</button>
    </div>
  </form>

</body>

<script>
  // Stub for e-Mongolia button (visual only, no real integration)
  function loginWithEMongolia() {
    // Do nothing - button is for display purposes only
    console.log("e-Mongolia integration not available (school project)");
  }

  // Helper to find global toast
  function showToast(message, type) {
    const toast = document.querySelector('ch-toast');
    if (toast) {
      toast.show(message, type);
    } else {
      alert(message);
    }
  }

  const select = document.getElementById('experience');
  for (let i = 1; i <= 10; i++) {
    const option = document.createElement('option');
    option.value = i;
    option.text = i + " жил";
    select.add(option);
  }

  // --- Dynamic Subcategories ---
  const CATEGORY_MAP = {
    "Дотор засал": ["Будаг", "Хана тааз засвар", "Шал"],
    "Тавилга угсралт": ["Гэр ахуйн", "Оффис", "Зөөвөр угсрах"],
    "Цэвэрлэгээ": ["Ерөнхий их", "Орон сууц/байшин", "Оффис"],
    "Нүүлгэлт": ["Оффис нүүлгэлт", "Том овор хүнд даац", "Гэр нүүлгэлт"],
    "Сантехник": ["Дотоод шугам", "Гал тогоо/угаалтуур", "Ариун цэврийн өрөө"],
    "Гадна талбай": ["Зүлэг хадах", "Цас цэвэрлэх", "Явган зам/хашаа"],
    "Цахилгаан": ["Гэрэлтүүлэг", "Розетка/унтраалга", "Засвар үйлчилгээ"]
  };

  const categorySelect = document.getElementById('category');
  const subContainer = document.getElementById('subcategory-container');
  const subOptions = document.getElementById('subcategory-options');

  categorySelect.addEventListener('change', (e) => {
    const cat = e.target.value;
    subOptions.innerHTML = ''; // Clear previous

    if (cat && CATEGORY_MAP[cat]) {
      subContainer.style.display = 'block';
      CATEGORY_MAP[cat].forEach(sub => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.gap = '10px';
        label.style.alignItems = 'center';
        label.innerHTML = `
            <input type="checkbox" name="subcategories" value="${sub}" style="width:16px; height:16px;">
            ${sub}
        `;
        subOptions.appendChild(label);
      });
    } else {
      subContainer.style.display = 'none';
    }
  });


  // Form submit handler
  document.getElementById('jobApplicationForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate Subcategories
    const checkedSubs = document.querySelectorAll('input[name="subcategories"]:checked');
    // NOTE: Optional? User said "when i filling sign up form i skipped subcategories". 
    // But they complained card didn't show up. If we force them, card will show up.
    // Let's make it REQUIRED if a category is selected?
    // "Also fix worker sign up... dynamically changes subcategories with 3 checkboxes"
    // I'll leave it not-strict for now to avoid blocking, but visually present.

    // Submit button-г идэвхгүй болгох (давхар илгээхээс сэргийлэх)
    const submitBtn = e.target.querySelector('.submit');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Илгээж байна...';

    // Form data цуглуулах
    const formData = new FormData(e.target);

    // Custom mapping to API expectations
    const payload = {
      lastname: formData.get('last'),
      firstname: formData.get('name'),
      email: formData.get('email'),
      phone: formData.get('dugaar'),
      address: formData.get('address'),
      password: formData.get('password'),
      category: formData.get('category'),
      subcategories: formData.getAll('subcategories'), // Get all checked boxes
      experience: formData.get('experience'),
      description: formData.get('message'),
      availability: formData.getAll('availability') // Get all checked boxes
    };

    console.log("Payload:", payload);

    try {
      const response = await fetch('/api/auth/signup/worker', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (response.ok) {
        // Амжилттай
        showToast('✅ Бүртгэл амжилттай! Та нэвтрэн орлоо.', 'success');
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);
      } else {
        // Алдаа гарсан
        showToast('❌ Алдаа гарлаа: ' + result.error, 'error');
      }
    } catch (error) {
      // Network буюу бусад алдаа
      console.error('Алдаа:', error);
      showToast('❌ Хүсэлт илгээхэд алдаа гарлаа. Дахин оролдоно уу.', 'error');
    } finally {
      // Button-г буцааж идэвхжүүлэх
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  // Phone number болон Age input-д зөвхөн тоо оруулах
  document.getElementById('dugaar').addEventListener('input', function (e) {
    this.value = this.value.replace(/[^0-9]/g, '');
  });

</script>

</html>